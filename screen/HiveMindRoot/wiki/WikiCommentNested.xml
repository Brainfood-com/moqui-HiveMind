<?xml version="1.0" encoding="UTF-8"?>
<!--
This is free and unencumbered software released into the public domain.
For specific language governing permissions and limitations refer to
the LICENSE.md file or http://unlicense.org
-->
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-1.5.xsd"
        default-menu-include="false">

    <parameter name="wikiPageId"/>
    <parameter name="currentCe"/>

    <transition name="wikiCommentReply"><default-response url="../WikiCommentReply"/></transition>

    <actions>
        <filter-map-list list="childCeList" to-list="filteredCeList">
            <field-map field-name="parentCommEventId" from="currentCe.communicationEventId"/>
        </filter-map-list>
    </actions>
    <widgets>
        <container style="task-comment-child">
            <section-iterate name="CommentChildList" list="filteredCeList" entry="childCe">
                <actions>
                    <set field="uniqueExtension" from="uniqueExtension + '_' + childCe_index"/>

                    <entity-find-one entity-name="mantle.party.Person" value-field="fromPerson" cache="true">
                        <field-map field-name="partyId" from="childCe.fromPartyId"/>
                    </entity-find-one>
                    <filter-map-list list="childCeList" to-list="childFilteredCeList">
                        <field-map field-name="parentCommEventId" from="childCe.communicationEventId"/>
                    </filter-map-list>
                </actions>
                <widgets>
                    <label text="${childCe.subject}" type="strong"/>
                    <label text="from ${fromPerson ? fromPerson.firstName + ' ' + fromPerson?.lastName : 'Unknown'}" type="span"/>
                    <label text="at ${childCe.entryDate}" type="span"/>
                    <dynamic-dialog id="ReplyCommentContainer${uniqueExtension}" button-text="Reply" transition="wikiCommentReply">
                        <parameter name="parentCommEventId" from="childCe.communicationEventId"/>
                    </dynamic-dialog>

                    <label text="${childCe.body}" type="pre" encode="false"/>

                    <!-- any nested child comments? -->
                    <section name="ChildNestedComments">
                        <condition><expression>childFilteredCeList</expression></condition>
                        <actions><set field="currentCe" from="childCe"/></actions>
                        <widgets><include-screen location="component://HiveMind/screen/HiveMindRoot/wiki/WikiCommentNested.xml"/></widgets>
                    </section>
                </widgets>
            </section-iterate>
        </container>
    </widgets>
</screen>
